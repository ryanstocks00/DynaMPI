# SPDX-FileCopyrightText: 2025 QDX Technologies. Authored by Ryan Stocks <ryan.stocks00@gmail.com>
# SPDX-License-Identifier: MIT
#
# Windows CI with multiple MPI implementations using setup-mpi action:
# - MS-MPI (supports MPI 2.2 + select MPI 3.1 features)
# - Intel MPI (full MPI 4.0 support)
# Uses mpi4py/setup-mpi for reliable installation
---
name: Windows
on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, reopened, synchronize]
env:
  CMAKE_CXX_STANDARD: 20
  CMAKE_VERBOSE_MAKEFILE: "ON"
jobs:
  windows-msmpi:
    name: Windows MS-MPI (MPI 3.1)
    runs-on: windows-latest
    strategy:
      matrix:
        build-type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Microsoft MPI
        uses: mpi4py/setup-mpi@3eef4c7b925e108e534a3856830963dedefac76f
        with:
          mpi: msmpi
      - name: Configure CMake (MS-MPI)
        shell: pwsh
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} `
            -DDYNAMPI_BUILD_TESTS=ON `
            -DDYNAMPI_BUILD_BENCHMARKS=ON
      - name: Build (MS-MPI)
        shell: pwsh
        run: cmake --build build --config ${{ matrix.build-type }} --parallel
      - name: Test (MS-MPI)
        shell: pwsh
        run: |
          cd build
          echo "Testing with Microsoft MPI (MPI 3.1 features)"
          ctest --output-on-failure --parallel -C ${{ matrix.build-type }}
  windows-mingw:
    name: Windows MinGW
    runs-on: windows-latest
    strategy:
      matrix:
        build-type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4
      - name: Install MinGW & Dependencies
        uses: msys2/setup-msys2@40677d36a502eb2cf0fb808cc9dec31bf6152638
        with:
          msystem: MINGW64
          update: true
          install: >
            mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make mingw-w64-x86_64-msmpi
            mingw-w64-x86_64-binutils mingw-w64-x86_64-tools

      - name: Install MS-MPI Runtime (for mpiexec)
        shell: pwsh
        run: |
          Invoke-WebRequest `
            "https://download.microsoft.com/download/a/5/2/a5207ca5-1203-491a-8fb8-906fd68ae623/msmpisetup.exe" `
            -OutFile "msmpisetup.exe"
          Start-Process -FilePath "msmpisetup.exe" -ArgumentList "-unattend" -Wait
          echo "MPI_TYPE=Microsoft MPI (MinGW)" >> $env:GITHUB_ENV
      - name: Generate libmsmpi.a for MinGW
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH:/c/Program Files/Microsoft MPI/Bin"

          echo "Checking gendef availability..."
          which gendef || { echo "gendef not found in PATH"; exit 1; }

          cd /tmp
          cp "/c/Windows/System32/msmpi.dll" . || cp "/c/Program Files/Microsoft MPI/Bin/msmpi.dll" .

          gendef msmpi.dll
          dlltool -d msmpi.def -l libmsmpi.a -D msmpi.dll
          cp libmsmpi.a /mingw64/lib/
      - name: Configure CMake (MinGW)
        shell: msys2 {0}
        run: |
          cmake -B build \
            -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DMPIEXEC_EXECUTABLE="/c/Program Files/Microsoft MPI/Bin/mpiexec.exe" \
            -DMPI_C_INCLUDE_PATH=/mingw64/include \
            -DMPI_CXX_INCLUDE_PATH=/mingw64/include \
            -DMPI_C_LIBRARIES=/mingw64/lib/libmsmpi.a \
            -DMPI_CXX_LIBRARIES=/mingw64/lib/libmsmpi.a \
            -DDYNAMPI_BUILD_TESTS=ON \
            -DDYNAMPI_BUILD_BENCHMARKS=ON
      - name: Build (MinGW)
        shell: msys2 {0}
        run: cmake --build build --config ${{ matrix.build-type }} --parallel
      - name: Test (MinGW)
        shell: msys2 {0}
        run: |
          cd build
          echo "Testing with $MPI_TYPE"
          ctest --output-on-failure --parallel -C ${{ matrix.build-type }}
  windows-intel-mpi:
    name: Windows Intel MPI (MPI 4.0)
    runs-on: windows-latest
    strategy:
      matrix:
        build-type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Intel MPI (MPI 4.0 support)
        uses: mpi4py/setup-mpi@3eef4c7b925e108e534a3856830963dedefac76f
        with:
          mpi: intelmpi
      - name: Configure CMake (Intel MPI)
        shell: pwsh
        run: |
          # Intel MPI environment should be set up by setup-mpi action
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} `
            -DDYNAMPI_BUILD_TESTS=ON `
            -DDYNAMPI_BUILD_BENCHMARKS=ON
      - name: Build (Intel MPI)
        shell: pwsh
        run: cmake --build build --config ${{ matrix.build-type }} --parallel
      - name: Test (Intel MPI)
        shell: pwsh
        run: |
          cd build
          echo "Testing with Intel MPI (MPI 4.0 support)"
          ctest --output-on-failure --parallel -C ${{ matrix.build-type }}
